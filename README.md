# ComfyUI YX EasyUse Plugin

一个专注于文件处理和工作流优化的ComfyUI插件集合。

## 功能特性

### 文件名格式化工具
- 🔧 **智能文件名清理**: 自动处理中文、特殊字符、emoji等问题字符
- 📅 **时间戳集成**: 基于文件修改时间添加时间戳
- 🌏 **中文转拼音**: 支持将中文字符转换为拼音（自动启用）
- 📁 **递归处理**: 自动处理所有子目录中的文件
- ⚡ **即时执行**: 直接重命名文件，无需预览
- ⚡ **智能去重**: 自动处理文件名冲突，添加序号
- 🎯 **参数精简**: 只需输入文件夹路径和前缀两个参数

### 批量视频精彩时刻剪辑工具 🆕
- 🎮 **智能检测**: 基于帧差检测自动识别无操作片段
- 🎯 **精准剪辑**: 自动剪辑出精彩内容，过滤无操作时间
- 📁 **批量处理**: 一次处理整个文件夹的游戏视频
- ⚙️ **参数可调**: 支持针对不同游戏类型调整检测参数
- 🎵 **音频保留**: 保持原视频音频轨道

## 安装方法

### 方法1: 使用ComfyUI Manager（推荐）
1. 在ComfyUI中安装ComfyUI Manager
2. 在Manager中搜索 "YX EasyUse"
3. 点击安装

### 方法2: 手动安装
```bash
cd ComfyUI/custom_nodes
git clone https://github.com/qq1151131109/comfyui-yx-easyuse.git
cd comfyui-yx-easyuse
pip install -r requirements.txt
```

## 依赖库

### 必需依赖
- `unicodedata` (Python内置)
- `pathlib` (Python内置)
- `opencv-python` (游戏视频剪辑功能)
- `numpy` (游戏视频剪辑功能)
- `ffmpeg-python` (游戏视频剪辑功能)

### 可选依赖
```bash
pip install pypinyin  # 用于中文转拼音功能
```

### FFmpeg 安装
游戏视频剪辑功能需要FFmpeg支持：
```bash
# Windows (使用Chocolatey)
choco install ffmpeg

# macOS (使用Homebrew)
brew install ffmpeg

# Ubuntu/Debian
sudo apt install ffmpeg
```

## 使用说明

### 文件名格式化工具

1. **基本用法**:
   - 在ComfyUI界面中：右键 → Add Node → YX剪辑 → 文件名格式化工具
   - 输入要处理的文件夹路径（绝对路径或相对于input目录的路径）
   - 设置文件名前缀（可选）
   - 点击执行即可完成重命名

2. **参数说明**:
   - `folder_path`: 目标文件夹路径（必需）
   - `prefix`: 新文件名前缀（默认: "file"）

3. **自动功能**（无需手动设置）:
   - ✅ 自动添加时间戳（基于文件修改时间）
   - ✅ 自动转换中文为拼音（需安装pypinyin）
   - ✅ 自动递归处理所有子目录
   - ✅ 直接执行重命名

4. **输出格式**:
   ```
   原文件名: 我的图片😊.JPG
   新文件名: file_20241225_143022_wodetupian.jpg

   原文件名: special@#$%characters.png
   新文件名: file_20241225_143025_special_characters.png

   原文件名: 子目录/emoji🌟file✨.doc
   新文件名: 子目录/file_20241225_143028_emojifile.doc
   ```

### 批量视频精彩时刻剪辑工具

1. **基本用法**:
   - 在ComfyUI界面中：右键 → Add Node → YX剪辑 → 批量视频精彩时刻剪辑
   - 输入游戏视频文件夹路径（绝对路径或相对于input目录的路径）
   - 调整检测参数（可选）
   - 点击执行

2. **参数详细说明**:
   - **`input_folder`**: 目标文件夹路径
     - 支持绝对路径或相对于ComfyUI input目录的路径
     - 会自动扫描该目录下所有支持的视频文件

   - **`output_folder_prefix`**: 输出文件夹前缀（默认: "game_auto_edit"）
     - 剪辑后的视频会保存在以此为前缀的新文件夹中
     - 自动添加唯一标识符避免文件夹名冲突

   - **`idle_threshold`**: 无操作检测敏感度（默认: 0.015，范围: 0.001-0.050）
     - 值越小，检测越敏感，更容易识别无操作片段
     - 值越大，检测越宽松，需要更明显的变化才认为是有操作
     - **调节建议**：
       - 消消乐类游戏：0.008-0.012（高敏感度）
       - 益智类游戏：0.010-0.015（中等敏感度）
       - 卡牌类游戏：0.015-0.025（较低敏感度）
       - 动作游戏：0.020-0.030（低敏感度）

   - **`min_segment_duration`**: 最小无操作片段时长（默认: 3.0秒，范围: 1.0-10.0）
     - 只有持续时间超过此值的无操作片段才会被剪辑掉
     - 避免剪掉短暂的思考时间，保持视频自然流畅
     - **调节建议**：
       - 快节奏游戏：1.5-2.5秒
       - 中等节奏：2.5-4.0秒
       - 慢节奏益智类：4.0-8.0秒

   - **`pixel_threshold`**: 像素变化过滤阈值（默认: 40，范围: 20-100）
     - 用于过滤鼠标移动、光标闪烁等微小变化
     - 值越高，越容易忽略细微变化；值越低，对变化更敏感
     - **调节建议**：
       - 高分辨率视频：50-80
       - 标准分辨率：30-50
       - 低分辨率视频：20-35

   - **`preserve_buffer`**: 保留缓冲时间（默认: 1.0秒，范围: 0.0-5.0）
     - 在无操作片段前后保留的时间，确保剪辑自然
     - 避免剪辑过于突兀，保持视频连贯性
     - **调节建议**：
       - 需要精准剪辑：0.2-0.8秒
       - 保持自然过渡：1.0-2.0秒
       - 宽松剪辑：2.0-3.0秒

3. **输出格式**:
   ```
   原视频: game_match3.mp4 (10分钟，包含3分钟停顿)
   剪辑后: game_match3_edited.mp4 (7分钟，纯精彩内容)
   ```

4. **适用游戏类型及推荐参数**:
   - **消消乐类游戏**
     - idle_threshold=0.012, min_segment_duration=2.5, pixel_threshold=35
   - **益智解谜类游戏**
     - idle_threshold=0.010, min_segment_duration=4.0, pixel_threshold=30
   - **卡牌类游戏**
     - idle_threshold=0.018, min_segment_duration=3.0, pixel_threshold=40
   - **动作游戏**
     - idle_threshold=0.025, min_segment_duration=2.0, pixel_threshold=50

5. **参数调节流程建议**:
   1. 首次使用建议用默认参数测试一个视频
   2. 根据剪辑效果调整参数：
      - 如果剪掉了有用内容 → 降低敏感度（增大idle_threshold）
      - 如果保留了太多停顿 → 提高敏感度（减小idle_threshold）
      - 如果剪辑太频繁 → 增大min_segment_duration
      - 如果受鼠标影响 → 增大pixel_threshold
   3. 微调preserve_buffer以获得最佳剪辑效果

## 特性详解

### 文件名清理规则
1. **中文处理**: 转换为拼音或移除
2. **Emoji移除**: 自动识别并移除emoji符号
3. **特殊字符**: 替换为下划线
4. **空格处理**: 转换为下划线
5. **连续下划线**: 合并为单个下划线
6. **扩展名**: 统一转换为小写

### 时间戳格式
- 格式: `YYYYMMDD_HHMMSS`
- 基于文件的最后修改时间
- 例子: `20241225_143022`

### 防重命名机制
- 自动检测文件名冲突
- 添加三位数序号: `_001`, `_002`, `_003`...
- 最大支持9999个重复文件

### 游戏视频检测原理
1. **帧差检测**: 比较相邻帧像素差异
2. **运动评分**: 计算每帧的运动分数
3. **阈值过滤**: 过滤小于阈值的变化（如鼠标移动）
4. **片段识别**: 识别持续时间超过最小时长的无操作片段
5. **智能剪辑**: 保留精彩片段，添加缓冲时间

## 常见问题

### Q: 中文转换不生效？
A: 请确保安装了pypinyin库: `pip install pypinyin`

### Q: 处理大量文件很慢？
A: 建议处理前备份重要文件，插件本身不提供撤销功能

### Q: 支持哪些文件格式？
A: 支持所有文件格式，主要处理文件名而不是文件内容

### Q: 可以恢复重命名吗？
A: 建议处理前备份重要文件，插件本身不提供撤销功能

## 更新日志

### v1.1.1
- 🚀 移除批量视频精彩时刻剪辑工具的预览模式，简化操作流程
- 🏷️ 更改节点名称为"批量视频精彩时刻剪辑"，更符合功能定位
- 📖 新增详细的参数调节说明和不同游戏类型推荐设置
- ⚙️ 优化参数说明，提供更精确的调节指导

### v1.1.0
- 🆕 新增批量视频精彩时刻剪辑工具
- 🎮 智能检测游戏无操作片段并自动剪辑
- 📁 支持批量处理游戏视频文件
- ⚙️ 可调参数适配不同游戏类型

### v1.0.1
- 🎯 文件名格式化工具简化优化
- ⚡ 参数精简：只保留必要的folder_path和prefix
- ⚡ 自动启用最佳默认设置（时间戳、递归、中文转拼音）
- ⚡ 直接执行重命名提高效率
- 🔧 优化用户体验，减少配置复杂度

### v1.0.0
- ✨ 初始发布
- 🔧 文件名格式化工具
- 📅 时间戳支持
- 🌏 中文转拼音支持
- 📁 递归目录处理

## 贡献指南

欢迎提交Issue和Pull Request！

## 许可证

MIT License

## 联系方式

- GitHub: [qq1151131109](https://github.com/qq1151131109)
- 项目地址: https://github.com/qq1151131109/comfyui-yx-easyuse